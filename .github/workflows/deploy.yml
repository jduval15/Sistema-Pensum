name: CI + Code Quality + Deploy - Sistema de Control de Pensum

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  deploy:
    name: VerificaciÃ³n completa y preparaciÃ³n de Deployment
    runs-on: ubuntu-latest

    strategy:
      matrix:
        project: [backend, frontend]

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Instalar dependencias
        working-directory: ./${{ matrix.project }}
        run: npm ci

      # ğŸ§  VerificaciÃ³n de Calidad
      - name: Verificar formato con Prettier
        run: |
          echo "ğŸ§¾ Verificando formato con Prettier..."
          npx prettier --check "**/*.{js,ts,tsx,json,md}" || (echo "âŒ Formato incorrecto detectado" && exit 1)
          echo "âœ… Formato correcto"

      - name: Verificar Linter (ESLint)
        run: |
          echo "ğŸ§¹ Ejecutando ESLint..."
          npx eslint . --ext .js,.ts,.tsx || (echo "âŒ Errores de lint detectados" && exit 1)
          echo "âœ… ESLint sin errores"

      - name: Verificar Tipos TypeScript
        if: matrix.project == 'frontend'
        working-directory: ./frontend
        run: |
          echo "ğŸ§  Verificando tipos TypeScript..."
          npx tsc --noEmit || (echo "âŒ Errores de tipos detectados" && exit 1)
          echo "âœ… Tipos verificados correctamente"

      - name: Ejecutar tests
        working-directory: ./${{ matrix.project }}
        run: |
          if npm test --if-present; then
            echo "âœ… Tests completados correctamente"
          else
            echo "âŒ Tests fallaron"
            exit 1
          fi

      # ğŸ—ï¸ Build y PreparaciÃ³n
      - name: Build Backend
        if: matrix.project == 'backend'
        working-directory: ./backend
        run: |
          echo "ğŸ—ï¸ Construyendo backend..."
          npx prisma generate || (echo "âŒ Error al generar Prisma Client" && exit 1)
          echo "âœ… Backend listo para producciÃ³n"

      - name: Build Frontend
        if: matrix.project == 'frontend'
        working-directory: ./frontend
        run: |
          echo "ğŸ—ï¸ Compilando frontend..."
          npm run build || (echo "âŒ Error compilando el frontend" && exit 1)
          
          echo "ğŸ” Verificando carpeta de salida..."
          if [ -d "dist" ]; then
            TARGET_DIR="dist"
          elif [ -d "build" ]; then
            TARGET_DIR="build"
          else
            echo "âŒ No se encontrÃ³ carpeta de build (dist/ o build/)"
            exit 1
          fi

          echo "ğŸ“ Contenido del build:"
          ls -lh $TARGET_DIR/ || echo "âš ï¸ No se pudo listar el contenido"

          echo "ğŸ“¦ TamaÃ±o total del build:"
          du -sh $TARGET_DIR/ || echo "âš ï¸ No se pudo calcular el tamaÃ±o"

      # ğŸ“‹ InformaciÃ³n general del deployment
      - name: InformaciÃ³n del Deployment
        run: |
          echo ""
          echo "ğŸš€ Sistema de Control de Pensum - Ready to Deploy"
          echo "ğŸ“¦ VersiÃ³n: $(date +%Y.%m.%d)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ’¬ Commit: ${{ github.event.head_commit.message }}"
          echo ""
          echo "Plataformas sugeridas para el despliegue:"
          echo "  â€¢ ğŸŸ© Vercel â†’ Frontend"
          echo "  â€¢ ğŸŸ¦ Railway â†’ Backend + Database"
          echo "  â€¢ ğŸŸª Render â†’ Full Stack"
          echo "  â€¢ ğŸŸ§ Heroku â†’ Full Stack"
          echo ""
          echo "ğŸ“š Revisa INSTRUCCIONES.md para detalles de configuraciÃ³n"

      # âœ… ValidaciÃ³n final
      - name: ValidaciÃ³n Pre-Deploy
        run: |
          echo "ğŸ” Validando estructura y archivos crÃ­ticos..."
          test -d backend || (echo "âŒ Falta carpeta backend" && exit 1)
          test -d frontend || (echo "âŒ Falta carpeta frontend" && exit 1)
          test -f README.md || (echo "âš ï¸ Falta README.md (recomendado)")
          echo "âœ… Proyecto verificado correctamente"

      - name: Deployment Ready âœ…
        run: |
          echo "ğŸ‰ El proyecto ha pasado todas las validaciones"
          echo "ğŸš€ Listo para deployment en la plataforma de tu elecciÃ³n"
          echo ""
          echo "ğŸ“ Estructura de producciÃ³n validada"
          echo "âœ”ï¸ Calidad del cÃ³digo aprobada"
          echo "ğŸ’ª Build generado correctamente"
